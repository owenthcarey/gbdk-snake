<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Snake (GBDK)</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      background: #0e0f12;
      color: #e8eaf0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    .container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100%;
      gap: 16px;
      padding: 24px 16px;
    }
    h1 {
      margin: 0 0 8px;
      font-size: 20px;
      font-weight: 600;
      color: #f5f7ff;
    }
    .subtle { color: #a9b0c3; font-size: 13px; }
    .screen-wrap {
      background: #1b1f27;
      border: 1px solid #2a3140;
      border-radius: 10px;
      padding: 16px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.35);
    }
    canvas {
      display: block;
      width: min(90vw, 640px);
      height: calc(min(90vw, 640px) * 0.9);
      max-width: 640px;
      max-height: 576px;
      image-rendering: pixelated;
      image-rendering: crisp-edges;
      background: #000;
    }
    .controls {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: center;
    }
    button {
      background: #3b82f6;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 10px 14px;
      font-size: 14px;
      cursor: pointer;
    }
    button:disabled { opacity: 0.6; cursor: default; }
    .hint { font-size: 12px; color: #9aa3b2; }
    a { color: #9cc2ff; }
  </style>
  <!-- WasmBoy: Game Boy / Game Boy Color WebAssembly emulator -->
  <script src="https://unpkg.com/wasmboy@latest/dist/wasmboy.min.js"></script>
</head>
<body>
  <div class="container">
    <div style="text-align:center">
      <h1>Snake (GBDK)</h1>
      <div class="subtle">Click Play to start (browser needs user interaction for audio)</div>
    </div>

    <div class="screen-wrap">
      <canvas id="screen" width="160" height="144"></canvas>
    </div>

    <div class="controls">
      <button id="playBtn">Play</button>
      <button id="pauseBtn" disabled>Pause</button>
      <button id="resetBtn" disabled>Reset</button>
      <a id="downloadLink" class="hint" download="snake.gb" href="#">Download ROM</a>
    </div>

    <div class="hint">D-Pad / Z (A) / X (B) / Enter (Start) / Shift (Select)</div>
  </div>

  <script>
    // Base64-encoded ROM gets injected by CI during deploy
    const ROM_BASE64 = 'ROM_BASE64_PLACEHOLDER';

    // Decode Base64 to Uint8Array
    function base64ToBytes(base64) {
      const binary = atob(base64);
      const bytes = new Uint8Array(binary.length);
      for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i) & 0xff;
      return bytes;
    }

    // Create a data: URL so users can download the ROM too
    function base64RomDataUrl(base64) {
      return 'data:application/octet-stream;base64,' + base64;
    }

    const romBytes = base64ToBytes(ROM_BASE64);
    const romDataUrl = base64RomDataUrl(ROM_BASE64);
    const downloadLink = document.getElementById('downloadLink');
    downloadLink.href = romDataUrl;

    const screen = document.getElementById('screen');
    const playBtn = document.getElementById('playBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    const resetBtn = document.getElementById('resetBtn');

    // Configure WasmBoy and wire up controls
    let configured = false;
    let loaded = false;

    function setControls(isPlaying) {
      playBtn.disabled = isPlaying;
      pauseBtn.disabled = !isPlaying;
      resetBtn.disabled = !loaded;
    }

    async function ensureConfigured() {
      if (configured) return;
      // Minimal sensible defaults
      const config = {
        isAudioEnabled: true,
        frameSkip: 1,
        speed: 1,
        useGbcWhenAvailable: true
      };
      await WasmBoy.config(screen, config);
      configured = true;
    }

    async function loadRom() {
      if (loaded) return;
      await ensureConfigured();
      await WasmBoy.loadROM(romBytes);
      loaded = true;
    }

    playBtn.addEventListener('click', async () => {
      try {
        await loadRom();
        await WasmBoy.play();
        setControls(true);
      } catch (e) {
        console.error(e);
        alert('Failed to start emulator. See console for details.');
      }
    });

    pauseBtn.addEventListener('click', async () => {
      try {
        await WasmBoy.pause();
        setControls(false);
      } catch (e) {
        console.error(e);
      }
    });

    resetBtn.addEventListener('click', async () => {
      try {
        await WasmBoy.reset();
        setControls(false);
        loaded = false;
      } catch (e) {
        console.error(e);
      }
    });

    // Initial state
    setControls(false);
  </script>
</body>
</html>
